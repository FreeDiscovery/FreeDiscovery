language: python
sudo: False
dist: trusty
env:
    global:
    - CONDA_CHANNELS="defaults conda-forge"
    matrix:
    - PYTHON_VERSION="3.6"
      REQUIREMENTS="requirements_engine.txt" EXTRA_DEPS=""
    - PYTHON_VERSION="3.6"
      REQUIREMENTS="requirements_engine.txt" EXTRA_DEPS="simhash-py gunicorn"
    #- python: "3.5"
    #- env: REQUIREMENTS="build_tools/requirements_compat.txt" EXTRA_DEPS="" SKLEARN_OLD=false
    - PYTHON_VERSION="3.5" 
      REQUIREMENTS="requirements.txt" EXTRA_DEPS="pytest"
    - PYTHON_VERSION="3.5" 
      REQUIREMENTS="requirements.txt" EXTRA_DEPS="pytest scikit-learn=0.18.1"
    - PYTHON_VERSION="2.7" 
      REQUIREMENTS="requirements.txt" EXTRA_DEPS="pytest"

install: 
    - git clone --depth 1 git://github.com/astropy/ci-helpers.git
    - source ci-helpers/travis/setup_conda.sh
    - |
        source activate test
        conda install --file ${REQUIREMENTS}
        conda install ${EXTRA_DEPS}
        pip install .

script:
    # run tests
    - pip install pytest-cov codecov
    - py.test -sv --cov=./
    # install matplotlib which we don't add as a core dependency but which is used in examples
    - conda install matplotlib
    # now start the server and run the examples
    - | 
        freediscovery run -y --cache-dir ../freediscovery_shared &
        FDSERVER_PID=$!
        sleep 20  
    - | 
        set -o pipefail
        for f in examples/*/*.py; do 
           python $f >> ~/log.txt
        done
        cat ../freediscovery_shared/freediscovery-backend.log && cat ~/log.txt && if grep -q "Traceback (most recent call last):" ~/log.txt ../freediscovery_shared/freediscovery-backend.log; then false; else true; fi

after_success:
    codecov --token=${CODECOV_TOKEN}
